{{define "content"}}
<div class="page-header">
    <h1>Settings</h1>
    <p>Configure your calendar integration and system preferences</p>
</div>

{{if .Error}}
<div class="alert alert-error">
    {{.Error}}
</div>
{{end}}
{{if .Updated}}
<div class="alert alert-success">
    Settings updated successfully.
</div>
{{end}}
{{if .NotificationsUpdated}}
<div class="alert alert-success">
    Notification settings updated successfully.
</div>
{{end}}

<!-- Google Calendar Connection -->
<div class="card mb-8 animate-fade-in-scale">
    <div class="card-header">
        <h3>Google Calendar</h3>
        <p>Connect your Google Calendar account</p>
    </div>
    <div class="card-body">
        <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: var(--space-4);">
            <div>
                <p style="font-weight: 500; color: var(--text-primary); margin-bottom: var(--space-1);">
                    {{if .OAuthConnected}}
                    <span style="display: inline-flex; align-items: center; gap: var(--space-2);">
                        <span class="status-dot status-dot-success"></span>
                        Connected
                    </span>
                    {{else}}
                    <span style="display: inline-flex; align-items: center; gap: var(--space-2);">
                        <span class="status-dot status-dot-error"></span>
                        Not Connected
                    </span>
                    {{end}}
                </p>
                <p class="text-sm" style="margin: 0; color: var(--text-secondary);">
                    {{if .OAuthConnected}}
                    Your Google Calendar is configured and ready for operations.
                    {{else}}
                    Connect to Google Calendar to enable calendar operations.
                    {{end}}
                </p>
            </div>
            {{if .OAuthConnected}}
            <a href="/oauth/start" class="btn btn-secondary">Reconnect Account</a>
            {{else}}
            <a href="/oauth/start" class="btn btn-primary">Connect Google Calendar</a>
            {{end}}
        </div>
    </div>
</div>

<!-- Notification Providers -->
<div class="card mb-8 animate-fade-in-scale" style="animation-delay: 50ms;">
    <div class="card-header">
        <h3>Notification Providers</h3>
        <p>Configure how you receive approval notifications</p>
    </div>
    <div class="card-body">
        <form action="/settings/notifications" method="POST">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

            <!-- ntfy -->
            <div class="provider-card">
                <div class="provider-header">
                    <div class="provider-title">
                        <h5>ntfy</h5>
                        <span class="provider-desc">Push notifications via ntfy.sh</span>
                    </div>
                    <div class="form-check" style="margin: 0;">
                        <input type="checkbox" id="ntfy_enabled" name="ntfy_enabled" class="form-check-input"
                               {{if .NtfyConfig.Enabled}}checked{{end}}
                               onchange="document.getElementById('ntfy_fields').style.display = this.checked ? 'block' : 'none'">
                        <label for="ntfy_enabled" class="form-check-label">Enable</label>
                    </div>
                </div>
                <div id="ntfy_fields" style="{{if not .NtfyConfig.Enabled}}display: none;{{end}}">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Server URL</label>
                            <input type="text" name="ntfy_server" value="{{.NtfyConfig.Server}}"
                                   class="form-input" placeholder="https://ntfy.sh">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Topic <span style="color: var(--error-700);">*</span></label>
                            <input type="text" name="ntfy_topic" value="{{.NtfyConfig.Topic}}"
                                   class="form-input" placeholder="your-topic-name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Access Token <small>(optional)</small></label>
                            <input type="password" name="ntfy_token" value="{{.NtfyConfig.Token}}"
                                   class="form-input" placeholder="tk_...">
                            <p class="form-hint">Required for private topics</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select name="ntfy_priority" class="form-select">
                                <option value="default" {{if eq .NtfyConfig.Priority "default"}}selected{{end}}>Default</option>
                                <option value="min" {{if eq .NtfyConfig.Priority "min"}}selected{{end}}>Min</option>
                                <option value="low" {{if eq .NtfyConfig.Priority "low"}}selected{{end}}>Low</option>
                                <option value="high" {{if eq .NtfyConfig.Priority "high"}}selected{{end}}>High</option>
                                <option value="urgent" {{if eq .NtfyConfig.Priority "urgent"}}selected{{end}}>Urgent</option>
                            </select>
                        </div>
                    </div>
                    {{if .NtfyConfig.Enabled}}
                    <div class="mt-4">
                        <button type="button" class="btn btn-ghost btn-sm" onclick="testProvider('ntfy')">Send Test Notification</button>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Pushover -->
            <div class="provider-card">
                <div class="provider-header">
                    <div class="provider-title">
                        <h5>Pushover</h5>
                        <span class="provider-desc">iOS/Android push notifications</span>
                    </div>
                    <div class="form-check" style="margin: 0;">
                        <input type="checkbox" id="pushover_enabled" name="pushover_enabled" class="form-check-input"
                               {{if .PushoverConfig.Enabled}}checked{{end}}
                               onchange="document.getElementById('pushover_fields').style.display = this.checked ? 'block' : 'none'">
                        <label for="pushover_enabled" class="form-check-label">Enable</label>
                    </div>
                </div>
                <div id="pushover_fields" style="{{if not .PushoverConfig.Enabled}}display: none;{{end}}">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Application Token <span style="color: var(--error-700);">*</span></label>
                            <input type="password" name="pushover_app_token" value="{{.PushoverConfig.AppToken}}"
                                   class="form-input" placeholder="a...">
                            <p class="form-hint">From pushover.net/apps</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">User Key <span style="color: var(--error-700);">*</span></label>
                            <input type="password" name="pushover_user_key" value="{{.PushoverConfig.UserKey}}"
                                   class="form-input" placeholder="u...">
                            <p class="form-hint">Your Pushover user key</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select name="pushover_priority" class="form-select">
                                <option value="-2" {{if eq .PushoverConfig.Priority -2}}selected{{end}}>Lowest</option>
                                <option value="-1" {{if eq .PushoverConfig.Priority -1}}selected{{end}}>Low</option>
                                <option value="0" {{if eq .PushoverConfig.Priority 0}}selected{{end}}>Normal</option>
                                <option value="1" {{if or (eq .PushoverConfig.Priority 1) (eq .PushoverConfig.Priority 0)}}selected{{end}}>High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sound</label>
                            <input type="text" name="pushover_sound" value="{{.PushoverConfig.Sound}}"
                                   class="form-input" placeholder="pushover">
                        </div>
                    </div>
                    {{if .PushoverConfig.Enabled}}
                    <div class="mt-4">
                        <button type="button" class="btn btn-ghost btn-sm" onclick="testProvider('pushover')">Send Test Notification</button>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Telegram -->
            <div class="provider-card">
                <div class="provider-header">
                    <div class="provider-title">
                        <h5>Telegram</h5>
                        <span class="provider-desc">Telegram bot notifications</span>
                    </div>
                    <div class="form-check" style="margin: 0;">
                        <input type="checkbox" id="telegram_enabled" name="telegram_enabled" class="form-check-input"
                               {{if .TelegramConfig.Enabled}}checked{{end}}
                               onchange="document.getElementById('telegram_fields').style.display = this.checked ? 'block' : 'none'">
                        <label for="telegram_enabled" class="form-check-label">Enable</label>
                    </div>
                </div>
                <div id="telegram_fields" style="{{if not .TelegramConfig.Enabled}}display: none;{{end}}">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Bot Token <span style="color: var(--error-700);">*</span></label>
                            <input type="password" name="telegram_bot_token" value="{{.TelegramConfig.BotToken}}"
                                   class="form-input" placeholder="123456:ABC...">
                            <p class="form-hint">From @BotFather</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Chat ID <span style="color: var(--error-700);">*</span></label>
                            <input type="text" name="telegram_chat_id" value="{{.TelegramConfig.ChatID}}"
                                   class="form-input" placeholder="-100...">
                            <p class="form-hint">User or group chat ID</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Webhook Secret <small>(optional)</small></label>
                            <input type="password" name="telegram_webhook_secret" value="{{.TelegramConfig.WebhookSecret}}"
                                   class="form-input" placeholder="random-secret">
                            <p class="form-hint">For securing incoming webhook callbacks</p>
                        </div>
                    </div>
                    {{if .TelegramConfig.Enabled}}
                    <div class="mt-4">
                        <button type="button" class="btn btn-ghost btn-sm" onclick="testProvider('telegram')">Send Test Notification</button>
                    </div>
                    {{end}}
                </div>
            </div>

            <div class="flex justify-end">
                <button type="submit" class="btn btn-primary">Save Notification Settings</button>
            </div>
        </form>
    </div>
</div>

<script>
function testProvider(provider) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/settings/test-notification';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{.CSRFToken}}';
    form.appendChild(csrfInput);

    const providerInput = document.createElement('input');
    providerInput.type = 'hidden';
    providerInput.name = 'provider';
    providerInput.value = provider;
    form.appendChild(providerInput);

    document.body.appendChild(form);
    form.submit();
}
</script>

<!-- Runtime Settings -->
<div class="card mb-8 animate-fade-in-scale" style="animation-delay: 100ms;">
    <div class="card-header">
        <h3>Runtime Settings</h3>
        <p>Configure approval workflow and system behavior</p>
    </div>
    <div class="card-body">
        <form action="/settings/save" method="POST">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

            <div class="mb-8">
                <h5 style="margin-bottom: var(--space-4);">Approval Settings</h5>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Timeout <small>(minutes)</small></label>
                        <input type="number" min="1" max="1440" name="approval_timeout_minutes" 
                               value="{{.Config.Approval.TimeoutMinutes}}"
                               class="form-input">
                        <p class="form-hint">How long before a request expires</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Default Action</label>
                        <select name="approval_default_action" class="form-select">
                            <option value="deny" {{if eq .Config.Approval.DefaultAction "deny"}}selected{{end}}>Deny on timeout</option>
                            <option value="approve" {{if eq .Config.Approval.DefaultAction "approve"}}selected{{end}}>Approve on timeout</option>
                        </select>
                        <p class="form-hint">Action when request expires</p>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h5 style="margin-bottom: var(--space-4);">Data Retention</h5>
                <div class="form-check mb-4">
                    <input type="checkbox" id="retention_enabled" name="retention_enabled" 
                           class="form-check-input" {{if .Config.Retention.Enabled}}checked{{end}}>
                    <label for="retention_enabled" class="form-check-label">Enable automatic cleanup of old data</label>
                </div>
                <div class="form-row three-col">
                    <div class="form-group">
                        <label class="form-label">Completed Requests <small>(days)</small></label>
                        <input type="number" min="1" max="3650" name="retention_completed_days" 
                               value="{{.Config.Retention.CompletedRequestsDays}}"
                               class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Audit Logs <small>(days)</small></label>
                        <input type="number" min="1" max="3650" name="retention_audit_days" 
                               value="{{.Config.Retention.AuditLogDays}}"
                               class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Webhook Failures <small>(days)</small></label>
                        <input type="number" min="1" max="3650" name="retention_webhook_failures_days" 
                               value="{{.Config.Retention.WebhookFailuresDays}}"
                               class="form-input">
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h5 style="margin-bottom: var(--space-4);">Logging</h5>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Log Level</label>
                        <select name="logging_level" class="form-select">
                            <option value="debug" {{if eq .Config.Logging.Level "debug"}}selected{{end}}>Debug</option>
                            <option value="info" {{if eq .Config.Logging.Level "info"}}selected{{end}}>Info</option>
                            <option value="warn" {{if eq .Config.Logging.Level "warn"}}selected{{end}}>Warn</option>
                            <option value="error" {{if eq .Config.Logging.Level "error"}}selected{{end}}>Error</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Log Format</label>
                        <select name="logging_format" class="form-select">
                            <option value="json" {{if eq .Config.Logging.Format "json"}}selected{{end}}>JSON</option>
                            <option value="text" {{if eq .Config.Logging.Format "text"}}selected{{end}}>Text</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h5 style="margin-bottom: var(--space-4);">Display</h5>
                <div class="form-row three-col">
                    <div class="form-group">
                        <label class="form-label">Timezone</label>
                        <input type="text" name="display_timezone" value="{{.Config.Display.Timezone}}"
                               class="form-input" placeholder="America/New_York">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date Format</label>
                        <input type="text" name="display_date_format" value="{{.Config.Display.DateFormat}}"
                               class="form-input" placeholder="Jan 2, 2006">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time Format</label>
                        <input type="text" name="display_time_format" value="{{.Config.Display.TimeFormat}}"
                               class="form-input" placeholder="3:04 PM">
                    </div>
                </div>
            </div>

            <div class="flex justify-end">
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </div>
        </form>
    </div>
</div>

<!-- Configuration Info -->
<div class="card animate-fade-in-scale" style="animation-delay: 150ms;">
    <div class="card-header">
        <h3>Current Configuration</h3>
        <p>Read-only system configuration values</p>
    </div>
    <div class="card-body">
        <dl class="dl-grid">
            <div class="dl-item">
                <dt>Approval Timeout</dt>
                <dd>{{.Config.Approval.TimeoutMinutes}} minutes</dd>
            </div>
            <div class="dl-item">
                <dt>Base URL</dt>
                <dd class="font-mono">{{.Config.Server.BaseURL}}</dd>
            </div>
            <div class="dl-item">
                <dt>Log Level</dt>
                <dd>{{.Config.Logging.Level}}</dd>
            </div>
            <div class="dl-item">
                <dt>Data Retention</dt>
                <dd>{{.Config.Retention.CompletedRequestsDays}} days</dd>
            </div>
        </dl>
    </div>
</div>
{{end}}

{{template "layout" .}}
