{{define "content"}}
<div class="mb-6">
    <a href="/pending" class="btn btn-ghost btn-sm" style="padding-left: 0;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to Pending
    </a>
</div>

<div class="card mb-8 animate-fade-in-scale">
    <div class="card-header">
        <div class="flex items-center justify-between" style="flex-wrap: wrap; gap: var(--space-3);">
            <div>
                <h2>Request Details</h2>
                <p class="font-mono text-sm" style="margin-top: var(--space-1); color: var(--text-tertiary);">{{.Request.ID}}</p>
            </div>
            <span class="badge
                {{if eq .Request.Status "pending_approval"}}badge-primary
                {{else if eq .Request.Status "approved"}}badge-success
                {{else if eq .Request.Status "denied"}}badge-error
                {{else}}badge-default{{end}}">
                {{.Request.Status}}
            </span>
        </div>
    </div>
    <div class="card-body">
        <dl class="dl-grid mb-8">
            <div class="dl-item">
                <dt>Operation</dt>
                <dd>
                    {{if eq .Request.Operation "create_event"}}Create Event
                    {{else if eq .Request.Operation "update_event"}}Update Event
                    {{else if eq .Request.Operation "delete_event"}}Delete Event
                    {{else}}{{.Request.Operation}}{{end}}
                </dd>
            </div>
            <div class="dl-item">
                <dt>API Key</dt>
                <dd class="font-mono">{{.Request.APIKeyID}}</dd>
            </div>
            <div class="dl-item">
                <dt>Created</dt>
                <dd>{{formatTime .Request.CreatedAt}}</dd>
            </div>
            <div class="dl-item">
                <dt>Expires</dt>
                <dd>{{formatTime .Request.ExpiresAt}}</dd>
            </div>
            {{if .Request.DecidedAt.Valid}}
            <div class="dl-item">
                <dt>Decided At</dt>
                <dd>{{formatTime .Request.DecidedAt.Time}}</dd>
            </div>
            {{end}}
            {{if .Request.DecidedBy.Valid}}
            <div class="dl-item">
                <dt>Decided By</dt>
                <dd>{{.Request.DecidedBy.String}}</dd>
            </div>
            {{end}}
        </dl>

        <!-- Human-Readable Event Details -->
        {{if .EventData}}
        <div class="mb-8">
            <h5 style="margin-bottom: var(--space-3);">Event Details</h5>
            <div class="event-details-card" style="background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--space-4); border: 1px solid var(--border-subtle);">
                {{if .EventData.Summary}}
                <div class="detail-row" style="margin-bottom: var(--space-3);">
                    <span class="detail-label" style="font-weight: 500; color: var(--text-secondary); display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">Title</span>
                    <span class="detail-value" style="font-size: 1.125rem; color: var(--text-primary);">{{.EventData.Summary}}</span>
                </div>
                {{end}}

                {{if or (not .EventData.Start.IsZero) (not .EventData.End.IsZero)}}
                <div class="detail-row" style="margin-bottom: var(--space-3); display: flex; gap: var(--space-6); flex-wrap: wrap;">
                    {{if not .EventData.Start.IsZero}}
                    <div>
                        <span class="detail-label" style="font-weight: 500; color: var(--text-secondary); display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">Start</span>
                        <span class="detail-value" style="color: var(--text-primary);">{{formatTime .EventData.Start}}</span>
                    </div>
                    {{end}}
                    {{if not .EventData.End.IsZero}}
                    <div>
                        <span class="detail-label" style="font-weight: 500; color: var(--text-secondary); display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">End</span>
                        <span class="detail-value" style="color: var(--text-primary);">{{formatTime .EventData.End}}</span>
                    </div>
                    {{end}}
                </div>
                {{end}}

                {{if .EventData.Location}}
                <div class="detail-row" style="margin-bottom: var(--space-3);">
                    <span class="detail-label" style="font-weight: 500; color: var(--text-secondary); display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">Location</span>
                    <span class="detail-value" style="color: var(--text-primary);">{{.EventData.Location}}</span>
                </div>
                {{end}}

                {{if .EventData.Description}}
                <div class="detail-row" style="margin-bottom: var(--space-3);">
                    <span class="detail-label" style="font-weight: 500; color: var(--text-secondary); display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">Description</span>
                    <span class="detail-value" style="color: var(--text-primary); white-space: pre-wrap;">{{.EventData.Description}}</span>
                </div>
                {{end}}

                {{if .EventData.Attendees}}
                <div class="detail-row" style="margin-bottom: var(--space-3);">
                    <span class="detail-label" style="font-weight: 500; color: var(--text-secondary); display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">Attendees</span>
                    <div class="detail-value" style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                        {{range .EventData.Attendees}}
                        <span class="badge badge-default">{{.}}</span>
                        {{end}}
                    </div>
                </div>
                {{end}}

                {{if .EventData.CalendarID}}
                <div class="detail-row" style="margin-bottom: var(--space-3);">
                    <span class="detail-label" style="font-weight: 500; color: var(--text-secondary); display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">Calendar</span>
                    <span class="detail-value font-mono text-sm" style="color: var(--text-primary);">{{.EventData.CalendarID}}</span>
                </div>
                {{end}}

                {{if .EventData.EventID}}
                <div class="detail-row">
                    <span class="detail-label" style="font-weight: 500; color: var(--text-secondary); display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-1);">Event ID</span>
                    <span class="detail-value font-mono text-sm" style="color: var(--text-primary);">{{.EventData.EventID}}</span>
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        <!-- Raw Payload (collapsible) -->
        <div class="mb-8">
            <details>
                <summary style="cursor: pointer; font-weight: 500; margin-bottom: var(--space-3); color: var(--text-secondary);">
                    Show Raw JSON Payload
                </summary>
                <pre>{{formatJSON .Payload}}</pre>
            </details>
        </div>

        {{if .Request.SuggestionText.Valid}}
        <div class="alert alert-warning mb-6">
            <h5 style="margin-bottom: var(--space-2);">Suggested Change</h5>
            <p style="margin-bottom: var(--space-2);">{{.Request.SuggestionText.String}}</p>
            <p class="text-xs" style="color: var(--text-tertiary); margin: 0;">
                Suggested by {{.Request.SuggestionBy.String}} at {{formatTime .Request.SuggestionAt.Time}}
            </p>
        </div>
        {{end}}

        {{if .Request.Error.Valid}}
        <div class="alert alert-error mb-6">
            <h5 style="margin-bottom: var(--space-2);">Error</h5>
            <p style="margin: 0;">{{.Request.Error.String}}</p>
        </div>
        {{end}}

        {{if .Request.Result}}
        <div>
            <h5 style="margin-bottom: var(--space-3);">Result</h5>
            <pre style="background-color: var(--success-50); border-color: rgba(21, 128, 61, 0.2);">{{formatJSON .Request.Result}}</pre>
        </div>
        {{end}}
    </div>

    <!-- Actions for Pending Requests -->
    {{if eq .Request.Status "pending_approval"}}
    <div class="card-footer">
        <!-- Edit Form (for create/update events) -->
        {{if or (eq .Request.Operation "create_event") (eq .Request.Operation "update_event")}}
        <div class="mb-6">
            <h5 style="margin-bottom: var(--space-3);">Edit Before Approval</h5>
            <form action="/requests/{{.Request.ID}}/update" method="POST" class="edit-payload-form">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

                <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-4);">
                    <div class="form-group">
                        <label class="form-label" for="edit-summary">Title</label>
                        <input type="text" id="edit-summary" name="summary" class="form-input"
                               value="{{if .EventData}}{{.EventData.Summary}}{{end}}"
                               placeholder="Event title">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-location">Location</label>
                        <input type="text" id="edit-location" name="location" class="form-input"
                               value="{{if .EventData}}{{.EventData.Location}}{{end}}"
                               placeholder="Event location">
                        <input type="hidden" name="location_present" value="1">
                    </div>
                </div>

                <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-4);">
                    <div class="form-group">
                        <label class="form-label" for="edit-start">Start Time</label>
                        <input type="datetime-local" id="edit-start" name="start" class="form-input"
                               value="{{if .EventData}}{{if not .EventData.Start.IsZero}}{{.EventData.Start.Format "2006-01-02T15:04"}}{{end}}{{end}}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-end">End Time</label>
                        <input type="datetime-local" id="edit-end" name="end" class="form-input"
                               value="{{if .EventData}}{{if not .EventData.End.IsZero}}{{.EventData.End.Format "2006-01-02T15:04"}}{{end}}{{end}}">
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label class="form-label" for="edit-description">Description</label>
                    <textarea id="edit-description" name="description" class="form-input" rows="3"
                              placeholder="Event description">{{if .EventData}}{{.EventData.Description}}{{end}}</textarea>
                    <input type="hidden" name="description_present" value="1">
                </div>

                <button type="submit" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 16px; height: 16px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                    </svg>
                    Save Changes
                </button>
            </form>
        </div>
        <div class="border-t pt-6 mb-6"></div>
        {{end}}

        <div style="display: flex; flex-wrap: wrap; gap: var(--space-3); margin-bottom: var(--space-4);">
            <form action="/requests/{{.Request.ID}}/approve" method="POST" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <button type="submit" class="btn btn-success">Approve Request</button>
            </form>
            <form action="/requests/{{.Request.ID}}/deny" method="POST" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <button type="submit" class="btn btn-danger">Deny Request</button>
            </form>
        </div>

        <!-- Suggest Change Form -->
        <div class="pt-6 border-t">
            <form action="/requests/{{.Request.ID}}/suggest" method="POST">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <div class="form-row" style="align-items: flex-end;">
                    <div class="form-group mb-0" style="flex: 1;">
                        <label for="suggestion" class="form-label">Suggest a Change</label>
                        <input type="text" id="suggestion" name="suggestion"
                               placeholder="Enter your suggestion for this request..."
                               class="form-input" required>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-secondary">Submit Suggestion</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {{end}}
</div>

<!-- Audit Log -->
{{if .AuditEntries}}
<div class="card animate-fade-in-scale" style="animation-delay: 100ms;">
    <div class="card-header">
        <h3>Audit Log</h3>
        <p>Activity history for this request</p>
    </div>
    <div class="list-group" style="border: none; border-top: 1px solid var(--border-subtle); border-radius: 0;">
        {{range .AuditEntries}}
        <div class="list-item">
            <div>
                <span style="font-weight: 500; color: var(--text-primary);">{{.EventType}}</span>
                <span class="text-sm" style="color: var(--text-tertiary); margin-left: var(--space-2);">by {{.Actor}}</span>
            </div>
            <span class="text-sm" style="color: var(--text-tertiary);">{{formatTime .Timestamp}}</span>
        </div>
        {{end}}
    </div>
</div>
{{end}}
{{end}}

{{template "layout" .}}
